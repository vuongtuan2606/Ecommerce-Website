<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{administrator/common :: html_head}"></head>
<body onload="time()" class="app sidebar-mini rtl">
<!-- Navbar-->
<header th:replace="~{administrator/common :: header}"></header>
<!-- Sidebar menu-->
<div th:replace="~{administrator/common :: menu_admin}"></div>
  <main class="app-content">
    <!--  Breadcrumb  -->
    <div class="app-title">
      <ul class="app-breadcrumb breadcrumb side">
        <li class="breadcrumb-item active"><a href="#"><b>Danh sách người dùng | [[${pageTitle}]] </b></a></li>
      </ul>
      <div class="date_time">
        <p id="current-date"></p> <p id="current-time"></p>
      </div>
    </div>
    <!-- row   -->
    <div class="row">
      <div class="col-md-12">
        <div class="tile">
          <div class="tile-body">
            <div class="row justify-content-center">
              <div class="col-xxl-12 col-xl-12 col-md-12">
                <div class="user-from-box-shadow">
                  <!-- Form  -->
                  <form th:action="@{/admin/users/save}" method="post"
                        enctype="multipart/form-data"
                        th:object="${user}"
                        onsubmit="return checkEmailUnique(this);">
                    <input type="hidden" th:field="*{id}">
                    <div class="form_user clearfix">
                      <h4 class="form_user_title">NHẬP THÔNG TIN</h4>
                      <fieldset class="form-group ">
                        <label>Email<span class="required">*</span></label>
                        <input  type="email"  class="form-control " th:field="*{email}" required minlength="8" maxlength="128" >
                      </fieldset>
                      <fieldset class="form-group ">
                        <label>First Name<span class="required">*</span></label>
                        <input  type="text"  class="form-control " th:field="*{firstName}" required minlength="2" maxlength="45" >
                      </fieldset>
                      <fieldset class="form-group ">
                        <label>Last Name<span class="required">*</span></label>
                        <input  type="text"  class="form-control " th:field="*{lastName}" required minlength="2" maxlength="45" >
                      </fieldset>
                      <fieldset class="form-group ">
                        <label>Password<span class="required">*</span></label>
                        <input  type="password"  class="form-control" th:field="*{password}"
                                th:if="${user.id == null}"  required minlength="8" maxlength="20" >
                        <input placeholder="bỏ qua nếu bạn không muốn thay đổi password" type="password"  class="form-control" th:field="*{password}"
                               th:if="${user.id != null}"   minlength="8" maxlength="20" >
                      </fieldset>
                      <fieldset class="form-group ">
                        <label>Role<span class="required">*</span></label>
                        <br>
                        <th:block th:each="role : ${listRoles}" >
                          <!-- private Set<Role> roles = new HashSet<Role>()-->
                          <input type="checkbox" th:field="*{roles}"
                                 th:text="${role.name}"
                                 th:value="${role.id}"
                          />
                          : <small th:text="${role.description}"></small>
                          <br>
                        </th:block>
                      </fieldset>
                      <fieldset class="form-group ">
                        <label>Enable<span class="required">*</span></label>
                        <input type="checkbox"  style="margin-left: 5px" th:field="*{enabled}"/>
                      </fieldset>
                      <fieldset class="form-group ">
                        <label>Photos<span class="required">*</span></label>
                        <input type="hidden" th:field="*{photos}">
                        <input type="file" name="image" class="form-control mb-2" style="margin-left: 5px; " id="fileImage" accept="image/png, image/jpeg" />
                        <img id="thumbnail" class="img-fluid" alt="photos preview" style="width: 150px; height: auto;" th:src="@{${user.photosImagePath}}">
                      </fieldset>
                      <div class="btn_submit">
                        <button class="btn btn-primary btn-style "  onclick="redirectToAdminUsers()" id="buttonCancel" type="button" >Hủy</button>
                        <button class="btn btn-success btn-style " type="submit" value="submit">Gửi thông tin</button>
                      </div>
                    </div>
                  </form>
                  <!--  Modal -->
                  <div class="modal" id="errorModal" tabindex="-1">
                    <div class="modal-dialog">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title" style="font-weight: 600">Thông báo</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                          <p style="text-align: center" id="modalBody"></p>
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
  <!-- script-->
  <span th:replace="~{administrator/common :: js}"></span>
  <script type="text/javascript">

    $(document).ready(function (){
      $("#fileImage").change(function (){
        fileSize = this.files[0].size;
        //alert("file size:" +fileSize);
        if(fileSize > 1048576){
          this.setCustomValidity("You must choose an image less than 1MB");
          this.reportValidity()
        }
        else {
          this.setCustomValidity("");
          showImageThumbnail(this);
        }

      })
    });
    function showImageThumbnail(fileInput){
      var file = fileInput.files[0];
      var reader = new FileReader();
      reader.onload = function (e){
        $("#thumbnail").attr("src", e.target.result);
      }
      reader.readAsDataURL(file);
    }
    function redirectToAdminUsers() {
      var url = "/admin/users";
      window.location.href = url;
    }

    function checkEmailUnique(form) {
      var url = "[[@{/users/check_email}]]";
      var userId =  $("#id").val();
      var userEmail = $("#email").val();
      var csrfValue = $("input[name='_csrf']").val();
      var params = {id:userId, email: userEmail, _csrf: csrfValue };

      $.post(url, params, function(response) {
        if (response == "OK") {
          form.submit();
        } else if (response == "Duplicated") {
          $("#modalBody").text("Email này đã tồn tại: " + userEmail);
          $('#errorModal').modal('show');
        } else {
          $("#modalBody").text("Không phản hồi từ máy chủ");
          $('#errorModal').modal('show');
        }
      });
      return false;
    }
</script>
</body>
</html>